import os

from flask import Flask, request
import logging
import json
import random

app = Flask(__name__)

logging.basicConfig(level=logging.INFO)

# —Å–æ–∑–¥–∞–µ–º —Å–ª–æ–≤–∞—Ä—å, –≤ –∫–æ—Ç–æ—Ä–æ–º –∫–ª—é—á ‚Äî –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞,
# –∞ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî –º–∞—Å—Å–∏–≤, –≥–¥–µ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω—ã id –∫–∞—Ä—Ç–∏–Ω–æ–∫,
# –∫–æ—Ç–æ—Ä—ã–µ –º—ã –∑–∞–ø–∏—Å–∞–ª–∏ –≤ –ø—Ä–æ—à–ª–æ–º –ø—É–Ω–∫—Ç–µ.

cities = {
    '–º–æ—Å–∫–≤–∞': ['1030494/47a85c81cbc483818df8',
               '1030494/7d6bc1516119eb7bf9c6'],
    '–Ω—å—é-–π–æ—Ä–∫': ['1030494/7da6c6579a4f9c389968',
                 '1030494/20729f85c95a63e5aab7'],
    '–ø–∞—Ä–∏–∂': ["1540737/a8c17f30ddac0d7884da",
              '1533899/cebf7f016540d47b3691'],
    '–∏–Ω–Ω–æ–ø–æ–ª–∏—Å üíó': ['965417/253dd1f49ac0ef259f8e', '1030494/dab37c787a04f5ef179d']
}

# —Å–æ–∑–¥–∞–µ–º —Å–ª–æ–≤–∞—Ä—å, –≥–¥–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
# –º—ã –±—É–¥–µ–º —Ö—Ä–∞–Ω–∏—Ç—å –µ–≥–æ –∏–º—è
sessionStorage = {}


@app.route('/', methods=['POST'])
@app.route('/post', methods=['POST'])
def main():
    logging.info(f'Request: {request.json!r}')
    response = {
        'session': request.json['session'],
        'version': request.json['version'],
        'response': {
            'end_session': False
        }
    }
    handle_dialog(response, request.json)
    logging.info(f'Response: {response!r}')
    return json.dumps(response)


def handle_dialog(res, req):
    user_id = req['session']['user_id']

    # –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–æ–≤—ã–π, —Ç–æ –ø—Ä–æ—Å–∏–º –µ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å—Å—è.
    if req['session']['new']:
        res['response']['text'] = '–ü—Ä–∏–≤–µ—Ç! –ù–∞–∑–æ–≤–∏ —Å–≤–æ–µ –∏–º—è!'
        # —Å–æ–∑–¥–∞–µ–º —Å–ª–æ–≤–∞—Ä—å –≤ –∫–æ—Ç–æ—Ä—ã–π –≤ –±—É–¥—É—â–µ–º –ø–æ–ª–æ–∂–∏–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        sessionStorage[user_id] = {
            'first_name': None
        }
        return

    # –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–æ–≤—ã–π, —Ç–æ –ø–æ–ø–∞–¥–∞–µ–º —Å—é–¥–∞.
    # –µ—Å–ª–∏ –ø–æ–ª–µ –∏–º–µ–Ω–∏ –ø—É—Å—Ç–æ–µ, —Ç–æ —ç—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç –æ —Ç–æ–º,
    # —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—â–µ –Ω–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏–ª—Å—è.
    if sessionStorage[user_id]['first_name'] is None:
        # –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–º –µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏—â–µ–º –∏–º—è.
        first_name = get_first_name(req)
        # –µ—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, —Ç–æ —Å–æ–æ–±—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —á—Ç–æ –Ω–µ —Ä–∞—Å—Å–ª—ã—à–∞–ª–∏.
        if first_name is None:
            res['response']['text'] = \
                '–ù–µ —Ä–∞—Å—Å–ª—ã—à–∞–ª–∞ –∏–º—è. –ü–æ–≤—Ç–æ—Ä–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞!'
        # –µ—Å–ª–∏ –Ω–∞—à–ª–∏, —Ç–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        # –ò —Å–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–∞–∫–æ–π –≥–æ—Ä–æ–¥ –æ–Ω —Ö–æ—á–µ—Ç —É–≤–∏–¥–µ—Ç—å.
        else:
            sessionStorage[user_id]['first_name'] = first_name
            res['response'][
                'text'] = '–ü—Ä–∏—è—Ç–Ω–æ –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è, ' \
                          + first_name.title() \
                          + '. –Ø - –ê–ª–∏—Å–∞. –ö–∞–∫–æ–π –≥–æ—Ä–æ–¥ —Ö–æ—á–µ—à—å —É–≤–∏–¥–µ—Ç—å?'
            # –ø–æ–ª—É—á–∞–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã buttons –∏–∑ –∫–ª—é—á–µ–π –Ω–∞—à–µ–≥–æ —Å–ª–æ–≤–∞—Ä—è cities
            res['response']['buttons'] = [
                {
                    'title': city.title(),
                    'hide': True
                } for city in cities
            ]
    # –µ—Å–ª–∏ –º—ã –∑–Ω–∞–∫–æ–º—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –∏ –æ–Ω –Ω–∞–º —á—Ç–æ-—Ç–æ –Ω–∞–ø–∏—Å–∞–ª,
    # —Ç–æ —ç—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç –æ —Ç–æ–º, —á—Ç–æ –æ–Ω —É–∂–µ –≥–æ–≤–æ—Ä–∏—Ç –æ –≥–æ—Ä–æ–¥–µ,
    # —á—Ç–æ —Ö–æ—á–µ—Ç —É–≤–∏–¥–µ—Ç—å.
    else:
        # –∏—â–µ–º –≥–æ—Ä–æ–¥ –≤ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        city = get_city(req)
        # –µ—Å–ª–∏ —ç—Ç–æ—Ç –≥–æ—Ä–æ–¥ —Å—Ä–µ–¥–∏ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –Ω–∞–º,
        # —Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ–≥–æ (–≤—ã–±–∏—Ä–∞–µ–º –æ–¥–Ω—É –∏–∑ –¥–≤—É—Ö –∫–∞—Ä—Ç–∏–Ω–æ–∫ —Å–ª—É—á–∞–π–Ω–æ)
        if city in cities:
            res['response']['card'] = {}
            res['response']['card']['type'] = 'BigImage'
            res['response']['card']['title'] = '–≠—Ç–æ—Ç –≥–æ—Ä–æ–¥ —è –∑–Ω–∞—é.'
            res['response']['card']['image_id'] = random.choice(cities[city])
            res['response']['text'] = '–Ø —É–≥–∞–¥–∞–ª!'
        # –µ—Å–ª–∏ –Ω–µ –Ω–∞—à–µ–ª, —Ç–æ –æ—Ç–≤–µ—á–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        # '–ü–µ—Ä–≤—ã–π —Ä–∞–∑ —Å–ª—ã—à—É –æ–± —ç—Ç–æ–º –≥–æ—Ä–æ–¥–µ.'
        else:
            res['response']['text'] = \
                '–ü–µ—Ä–≤—ã–π —Ä–∞–∑ —Å–ª—ã—à—É –æ–± —ç—Ç–æ–º –≥–æ—Ä–æ–¥–µ. –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑–æ–∫!'


def get_city(req):
    # –ø–µ—Ä–µ–±–∏—Ä–∞–µ–º –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏
    for entity in req['request']['nlu']['entities']:
        # –µ—Å–ª–∏ —Ç–∏–ø YANDEX.GEO —Ç–æ –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –≥–æ—Ä–æ–¥(city),
        # –µ—Å–ª–∏ –Ω–µ—Ç, —Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º None
        if entity['type'] == 'YANDEX.GEO':
            # –≤–æ–∑–≤—Ä–∞—â–∞–µ–º None, –µ—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ —Å—É—â–Ω–æ—Å—Ç–∏ —Å —Ç–∏–ø–æ–º YANDEX.GEO
            return entity['value'].get('city', None)


def get_first_name(req):
    # –ø–µ—Ä–µ–±–∏—Ä–∞–µ–º —Å—É—â–Ω–æ—Å—Ç–∏
    for entity in req['request']['nlu']['entities']:
        # –Ω–∞—Ö–æ–¥–∏–º —Å—É—â–Ω–æ—Å—Ç—å —Å —Ç–∏–ø–æ–º 'YANDEX.FIO'
        if entity['type'] == 'YANDEX.FIO':
            # –ï—Å–ª–∏ –µ—Å—Ç—å —Å—É—â–Ω–æ—Å—Ç—å —Å –∫–ª—é—á–æ–º 'first_name',
            # —Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.
            # –í–æ –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö –≤–æ–∑–≤—Ä–∞—â–∞–µ–º None.
            return entity['value'].get('first_name', None)


def main():
    port = int(os.environ.get("PORT", 5000))
    app.run(host='0.0.0.0', port=port)


if __name__ == '__main__':
    main()
